<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="How to setup a highly-available Kubernetes cluster on Bare-Metal" /><meta property="og:locale" content="en" /><meta name="description" content="Setting up Kubernetes in a highly-available configuration" /><meta property="og:description" content="Setting up Kubernetes in a highly-available configuration" /><link rel="canonical" href="https://chaseddevelopment.github.io/posts/kubernetes/" /><meta property="og:url" content="https://chaseddevelopment.github.io/posts/kubernetes/" /><meta property="og:site_name" content="Guides" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-05-03T11:00:00-06:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="How to setup a highly-available Kubernetes cluster on Bare-Metal" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-29T12:25:21-06:00","datePublished":"2021-05-03T11:00:00-06:00","description":"Setting up Kubernetes in a highly-available configuration","headline":"How to setup a highly-available Kubernetes cluster on Bare-Metal","mainEntityOfPage":{"@type":"WebPage","@id":"https://chaseddevelopment.github.io/posts/kubernetes/"},"url":"https://chaseddevelopment.github.io/posts/kubernetes/"}</script><title>How to setup a highly-available Kubernetes cluster on Bare-Metal | Guides</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Guides"><meta name="application-name" content="Guides"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/posts/ProfilePic.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Guides</a></div><div class="site-subtitle font-italic">Homelab Guides and Documentation</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/github_username" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/ChaseDubauskas" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['Chase','ChaseDDevelopment.tech'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>How to setup a highly-available Kubernetes cluster on Bare-Metal</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>How to setup a highly-available Kubernetes cluster on Bare-Metal</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/username">Chase Dubauskas</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1620061200" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2021-05-03 </em> </span> <span> Updated <em class="timeago" data-ts="1653848721" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-29 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2027 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><h1 id="setting-up-kubernetes-in-a-highly-available-configuration">Setting up Kubernetes in a highly-available configuration</h1><p>This is a guide to provision a Highly Available Kubernetes Cluster (K8s) on v1.21</p><h1>This is my Personal Homelab Kubernetes Cluster, and I've taken around 40 Bookmarked webpages and condensed them into one guide.</h1><p>This Kubernetes cluster uses a Multi-Master stacked topology. I stuggled for a few days to find all the steps that would work for one installation on bare metal, and had to take some pieces from several places to get this to work the way it does. This cluster will be using <a href="https://www.projectcalico.org/">Calico</a> as it’s Container Network Interface.</p><p>Please don’t hesitate to raise any issues with the guide, I’ll update it, and try to help where I can!</p><h2> Installation Guide</h2><h2 id="1-provision-9-13-ubuntu-server-20041-at-the-time-of-writing-virtual-machines-with-an-admin-user-called-kube-optional-just-personal-preference"><span class="mr-2">1. Provision 9-13 Ubuntu Server 20.04.1 (At the time of writing) virtual machines with an admin user called “kube” (optional, just personal preference)</span><a href="#1-provision-9-13-ubuntu-server-20041-at-the-time-of-writing-virtual-machines-with-an-admin-user-called-kube-optional-just-personal-preference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>2 Load Balancer Servers with minimum 4 cores, and 4GiB of RAM, 32 GiB Storage<li>3 Control Plane Servers with minimum 4 cores, and 4GiB of RAM, 32 GiB Storage<li>4 Worker Node Servers with minimum 4 cores, and 8GiB of RAM, 32GiB Storage<li>(Optional) 4 Storage Node Servers with minimum 4 cores, 8GiB of RAM, 100GiB Storage</ul><p>These Values are just what work best in <em>MY</em> Homelab, and the resources I have available, you can modify them accordingly, just make sure they fall within <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#before-you-begin">Kubernetes minimum Requirements</a></p><p>The reason I say 9-13 Servers, is the extra 4 are Storage nodes. These nodes are setup with 100GiB each because I planned to use Longhorn as taught in TechnoTim’s Guides, so you can do this without the additional storage nodes, or use them as more worker nodes if you don’t plan on using storage nodes.</p><h2 id="2-setup-an-additional-user-on-each-ubuntu-server-with-sudo-privelages-so-that-the-machine-can-be-managed-by-ansible"><span class="mr-2">2. Setup an additional user on each Ubuntu Server with Sudo privelages (so that the machine can be managed by ansible):</span><a href="#2-setup-an-additional-user-on-each-ubuntu-server-with-sudo-privelages-so-that-the-machine-can-be-managed-by-ansible" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="nb">sudo </span>adduser serveradmin
</pre></table></code></div></div><p>Followed by:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>usermod <span class="nt">-aG</span> <span class="nb">sudo </span>serveradmin
</pre></table></code></div></div><h2 id="3-setup-ssh-key-based-authentication-and-copy-the-ids-to-each-server"><span class="mr-2">3. Setup SSH Key based authentication, and copy the ID’s to each server</span><a href="#3-setup-ssh-key-based-authentication-and-copy-the-ids-to-each-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ssh-keygen <span class="c">#Run this on your Local Development Machine</span>
</pre></table></code></div></div><p>Followed by:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ssh-copy-id <span class="o">{</span>user<span class="o">}</span>@<span class="o">{</span>IP Address<span class="o">}</span> <span class="c"># Do this for both kube &amp; serveradmin</span>
</pre></table></code></div></div><h2 id="4-install-ansible-on-your-local-machine"><span class="mr-2">4. Install Ansible on your Local Machine:</span><a href="#4-install-ansible-on-your-local-machine" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>ansible
<span class="nb">sudo </span>apt <span class="nb">install </span>sshpass <span class="c"># This is needed if you are using password based authentication.</span>
</pre></table></code></div></div><p><a href="https://galaxy.ansible.com/community/general">Ansible Galaxy Community General</a></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ansible-galaxy collection <span class="nb">install </span>community.general
</pre></table></code></div></div><p><a href="https://galaxy.ansible.com/gantsign/oh-my-zsh">Ansible Galaxy Gantsign.OhMyZsh</a></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ansible-galaxy <span class="nb">install </span>gantsign.oh-my-zsh
</pre></table></code></div></div><h2 id="5-provision-the-13-servers-using-ansible-using-technotims-ansible-files-the-host-file-kuber-has-all-my-kubernetes-hosts-technotim-ansible"><span class="mr-2">5. Provision the 13 Servers using ansible using TechnoTim’s Ansible Files. the Host file <code class="language-plaintext highlighter-rouge"><span class="mr-2">kuber</code> has all my kubernetes hosts. <a href="https://github.com/techno-tim/ansible-homelab"><span class="mr-2">TechnoTim Ansible</a></span><a href="#5-provision-the-13-servers-using-ansible-using-technotims-ansible-files-the-host-file-kuber-has-all-my-kubernetes-hosts-technotim-ansible" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>ansible-playbook ~/ansible/playbooks/apt.yml <span class="nt">--user</span> serveradmin <span class="nt">--ask-become-pass</span> <span class="nt">-i</span> ~/ansible/inventory/kuber
ansible-playbook ~/ansible/playbooks/apt-dist.yml <span class="nt">--user</span> serveradmin <span class="nt">--ask-become-pass</span> <span class="nt">-i</span> ~/ansible/inventory/kuber
ansible-playbook ~/ansible/playbooks/qemu-guest-agent.yml <span class="nt">--user</span> serveradmin <span class="nt">--ask-become-pass</span> <span class="nt">-i</span> ~/ansible/inventory/kuber
ansible-playbook ~/ansible/playbooks/timezone.yml <span class="nt">--user</span> serveradmin <span class="nt">--ask-become-pass</span> <span class="nt">-i</span> ~/ansible/inventory/kuber
ansible-playbook ~/ansible/playbooks/zsh.yml <span class="nt">--user</span> serveradmin <span class="nt">--ask-become-pass</span> <span class="nt">-i</span> ~/ansible/inventory/kuber
ansible-playbook ~/ansible/playbooks/oh-my-zsh.yml <span class="nt">--user</span> serveradmin <span class="nt">--ask-become-pass</span> <span class="nt">-i</span> ~/ansible/inventory/kuber <span class="c"># also do this for kube user if desired</span>
ansible-playbook ~/ansible/playbooks/resize-lvm.yml <span class="nt">--user</span> serveradmin <span class="nt">--ask-become-pass</span> <span class="nt">-i</span> ~/ansible/inventory/kuber
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>This should provision all the Ubuntu Servers and have them prepped for a Kubernetes cluster installation</p></div></blockquote><h2 id="6-install-kubectl-on-your-local-dev-machine-install-kubernetes-tools"><span class="mr-2">6. Install Kubectl on your local dev machine: <a href="https://kubernetes.io/docs/tasks/tools/"><span class="mr-2">Install Kubernetes Tools</a></span><a href="#6-install-kubectl-on-your-local-dev-machine-install-kubernetes-tools" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h2 id="7-create-the-highly-available-load-balancer-with-a-virtual-ip-address-for-access-to-the-kubernetes-api-server-endpoint"><span class="mr-2">7. Create the highly-available load-balancer with a virtual IP address for access to the kubernetes API Server endpoint</span><a href="#7-create-the-highly-available-load-balancer-with-a-virtual-ip-address-for-access-to-the-kubernetes-api-server-endpoint" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li><p>ssh into both load balancer nodes, and install <code class="language-plaintext highlighter-rouge">keepalived</code> and <code class="language-plaintext highlighter-rouge">haproxy</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>keepalived haproxy
</pre></table></code></div></div><li><p>Access <code class="language-plaintext highlighter-rouge">keepalived</code> config at <code class="language-plaintext highlighter-rouge">/etc/keepalived/keepalived.conf</code> on both nodes. The API server port by default is <code class="language-plaintext highlighter-rouge">6443</code> Please check the notes below for information on the values.</p><div class="language-conf highlighter-rouge"><div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="n">global_defs</span> {
    <span class="n">router_id</span> <span class="n">LVS_DEVEL</span>
}
<span class="n">vrrp_script</span> <span class="n">check_apiserver</span> {
  <span class="n">script</span> <span class="s2">"/etc/keepalived/check_apiserver.sh"</span>
  <span class="n">interval</span> <span class="m">3</span>
  <span class="n">weight</span> -<span class="m">2</span>
  <span class="n">fall</span> <span class="m">10</span>
  <span class="n">rise</span> <span class="m">2</span>
}

<span class="n">vrrp_instance</span> ${<span class="n">VI_</span><span class="c">#} {
</span>    <span class="n">state</span> ${<span class="n">STATE</span>} <span class="c"># value: MASTER
</span>    <span class="n">interface</span> ${<span class="n">INTERFACE</span>} <span class="c"># value: ens18
</span>    <span class="n">virtual_router_id</span> ${<span class="n">ROUTER_ID</span>} <span class="c">#value: 51
</span>    <span class="n">priority</span> ${<span class="n">PRIORITY</span>} <span class="c"># value: 101
</span>    <span class="n">authentication</span> {
        <span class="n">auth_type</span> <span class="n">PASS</span>
        <span class="n">auth_pass</span> ${<span class="n">AUTH_PASS</span>} <span class="c"># value: {RandomPassword}
</span>    }
    <span class="n">virtual_ipaddress</span> {
        ${<span class="n">APISERVER_VIP</span>} <span class="c"># value: 192.168.x.x
</span>    }
    <span class="n">track_script</span> {
        <span class="n">check_apiserver</span>
    }
}
</pre></table></code></div></div><hr /><ul><li>${VI_#} - This is the instance number. Change it on both load balancers. for simplicity I made mine <code class="language-plaintext highlighter-rouge">VI_1</code> on the “Master” and <code class="language-plaintext highlighter-rouge">VI_2</code> on the “Backup”.<li>${STATE} - This value Will be <code class="language-plaintext highlighter-rouge">MASTER</code> on the first loadbalancer and <code class="language-plaintext highlighter-rouge">BACKUP</code> on the second loadbalancer.<li>${INTERFACE} - This is the physical network interface on the Ubuntu Server, change accordingly. Mine is <code class="language-plaintext highlighter-rouge">ens18</code><li>${ROUTER_ID} - This is a random value, just make sure the value on the “Master” loadbalancer is lower. e.g <code class="language-plaintext highlighter-rouge">51</code> and <code class="language-plaintext highlighter-rouge">52</code> on the “Backup”.<li>${PRIORITY} - This is a random value, just make the value on the “Master” load balancer is lower. e.g <code class="language-plaintext highlighter-rouge">101</code> and <code class="language-plaintext highlighter-rouge">200</code> on the “Backup”.<li>${AUTH_PASS} - This is a random password, use any generator and avoid special characters. This will be the same on both loadbalancers.<li>${APISERVER_VIP} - This is the virtual IP address that both load balancers will be sharing. Change it based on your local network and available address’. Make sure this address is not within the DHCP servers range.</ul><li><p>Add the script that <code class="language-plaintext highlighter-rouge">keepalived</code> uses at <code class="language-plaintext highlighter-rouge">/etc/keepalived/check_apiserver.sh</code> on both nodes. the <code class="language-plaintext highlighter-rouge">APISERVER_VIP</code> is the Virtual IP assigned to <code class="language-plaintext highlighter-rouge">keepalived</code> above and <code class="language-plaintext highlighter-rouge">APISERVER_DEST_PORT</code> is <code class="language-plaintext highlighter-rouge">6443</code>. (Thats the default API Server port)</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>

errorExit<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"*** </span><span class="nv">$*</span><span class="s2">"</span> 1&gt;&amp;2
    <span class="nb">exit </span>1
<span class="o">}</span>

curl <span class="nt">--silent</span> <span class="nt">--max-time</span> 2 <span class="nt">--insecure</span> https://localhost:<span class="k">${</span><span class="nv">APISERVER_DEST_PORT</span><span class="k">}</span>/ <span class="nt">-o</span> /dev/null <span class="o">||</span> errorExit <span class="s2">"Error GET https://localhost:</span><span class="k">${</span><span class="nv">APISERVER_DEST_PORT</span><span class="k">}</span><span class="s2">/"</span>
<span class="k">if </span>ip addr | <span class="nb">grep</span> <span class="nt">-q</span> <span class="k">${</span><span class="nv">APISERVER_VIP</span><span class="k">}</span><span class="p">;</span> <span class="k">then
    </span>curl <span class="nt">--silent</span> <span class="nt">--max-time</span> 2 <span class="nt">--insecure</span> https://<span class="k">${</span><span class="nv">APISERVER_VIP</span><span class="k">}</span>:<span class="k">${</span><span class="nv">APISERVER_DEST_PORT</span><span class="k">}</span>/ <span class="nt">-o</span> /dev/null <span class="o">||</span> errorExit <span class="s2">"Error GET https://</span><span class="k">${</span><span class="nv">APISERVER_VIP</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">APISERVER_DEST_PORT</span><span class="k">}</span><span class="s2">/"</span>
<span class="k">fi</span>
</pre></table></code></div></div><li><p>Modify the <code class="language-plaintext highlighter-rouge">HAProxy</code> configuration file located at <code class="language-plaintext highlighter-rouge">/etc/haproxy/haproxy.cfg</code> on both nodes</p><pre><code class="language-cfg">    # /etc/haproxy/haproxy.cfg
    #---------------------------------------------------------------------
    # Global settings
    #---------------------------------------------------------------------
    global
        log /dev/log local0
        log /dev/log local1 notice
        daemon

    #---------------------------------------------------------------------
    # common defaults that all the 'listen' and 'backend' sections will
    # use if not designated in their block
    #---------------------------------------------------------------------
    defaults
        mode                    http
        log                     global
        option                  httplog
        option                  dontlognull
        option http-server-close
        option forwardfor       except 127.0.0.0/8
        option                  redispatch
        retries                 1
        timeout http-request    10s
        timeout queue           20s
        timeout connect         5s
        timeout client          20s
        timeout server          20s
        timeout http-keep-alive 10s
        timeout check           10s

    #---------------------------------------------------------------------
    # apiserver frontend which proxys to the masters
    #---------------------------------------------------------------------
    frontend apiserver
        bind *:${APISERVER_DEST_PORT}
        mode tcp
        option tcplog
        default_backend apiserver

    #---------------------------------------------------------------------
    # round robin balancing for apiserver
    #---------------------------------------------------------------------
    backend apiserver
        option httpchk GET /healthz
        http-check expect status 200
        mode tcp
        option ssl-hello-chk
        balance     roundrobin
            server ${HOST1_ID} ${HOST1_ADDRESS}:${APISERVER_SRC_PORT} check fall 3 rise 2 # for me ${HOST1_ID} is kube_control_plane1. Add all your control Planes here.
            server ${HOST2_ID} ${HOST2_ADDRESS}:${APISERVER_SRC_PORT} check fall 3 rise 2
            server ${HOST3_ID} ${HOST3_ADDRESS}:${APISERVER_SRC_PORT} check fall 3 rise 2
            # [...]
</code></pre><hr /><ul><li>${APISERVER_DEST_PORT} - By default the API Server’s port is <code class="language-plaintext highlighter-rouge">6443</code>, so thats what I am using here.<li>${HOST1_ID} - This is what the hostname is on the server, I called mine <code class="language-plaintext highlighter-rouge">kube-control-plane1</code>.<li>${HOST1_ADDRESS} - This is the IP Address for the first control plane.<li>${APISERVER_SRC_PORT} - This is the port for the API Server. (<code class="language-plaintext highlighter-rouge">6443</code>)</ul><li><p>Enable <code class="language-plaintext highlighter-rouge">Haproxy</code> &amp; <code class="language-plaintext highlighter-rouge">keepalived</code> in <code class="language-plaintext highlighter-rouge">systemd</code> on both nodes</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl <span class="nb">enable </span>haproxy.service
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>keepalived.service
</pre></table></code></div></div><li><p>Check to see if you can connect to the virtual IP address assigned by `keepalived if you get a connection refused that is fine because the Kubernetes api server is not yet running. But if you get a timeout error, then check your config.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nc <span class="nt">-v</span> <span class="o">{</span>VirtualIP<span class="o">}</span> <span class="o">{</span>PORT<span class="o">}</span>
</pre></table></code></div></div><li><p>Prepare Each Node for Kubernetes Install</p><ol><li><p>Disable Firewall on all nodes</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>ufw disable
</pre></table></code></div></div><li><p>Disable Swap on all nodes</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>swapoff <span class="nt">-a</span><span class="p">;</span> <span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s1">'/swap/d'</span> /etc/fstab
</pre></table></code></div></div><li><p>Make sure IPTables can see bridged Traffic on all nodes</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee /etc/modules-load.d/k8s.conf
br_netfilter
</span><span class="no">EOF

</span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
</span><span class="no">EOF
</span><span class="nb">sudo </span>sysctl <span class="nt">--system</span>
</pre></table></code></div></div><li><p>Install Docker engine on all the nodes and mark the packages as “held back”.</p><p><a href="https://docs.docker.com/engine/install/">Docker Install</a></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt-mark hold docker-ce docker-ce-cli
</pre></table></code></div></div><li><p>Set Docker to use <code class="language-plaintext highlighter-rouge">systemd</code> as the control group driver.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nb">sudo mkdir</span> /etc/docker
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee /etc/docker/daemon.json
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
},
"storage-driver": "overlay2"
}
</span><span class="no">EOF
</span></pre></table></code></div></div><p>Then Restart Docker and enable on boot.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl <span class="nb">enable </span>docker
<span class="nb">sudo </span>systemctl daemon-reload
<span class="nb">sudo </span>systemctl restart docker
</pre></table></code></div></div><li><p>Install <code class="language-plaintext highlighter-rouge">Kubeadm</code>, <code class="language-plaintext highlighter-rouge">Kubelet</code>, and <code class="language-plaintext highlighter-rouge">kubectl</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> apt-transport-https ca-certificates curl

<span class="nb">sudo </span>curl <span class="nt">-fsSLo</span> /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg

<span class="nb">echo</span> <span class="s2">"deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main"</span> | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/kubernetes.list

<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> kubelet kubeadm kubectl
<span class="nb">sudo </span>apt-mark hold kubelet kubeadm kubectl

</pre></table></code></div></div></ol></ol><h2 id="8-intiliaze-the-first-control-plane-on-the-cluster-and-copy-the-contents-of-the-output-to-a-text-file-for-later-use"><span class="mr-2">8. Intiliaze the first control plane on the cluster and copy the contents of the output to a text file for later use.</span><a href="#8-intiliaze-the-first-control-plane-on-the-cluster-and-copy-the-contents-of-the-output-to-a-text-file-for-later-use" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>kubeadm init <span class="nt">--control-plane-endpoint</span> <span class="s2">"</span><span class="k">${</span><span class="nv">LOAD_BALANCER_VIP</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">LOAD_BALANCER_PORT</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--upload-certs</span> <span class="nt">--pod-network-cidr</span> 192.168.0.0/16
</pre></table></code></div></div><hr /><ul><li>${LOAD_BALANCER_VIP} - This is the Virtual IP address of <code class="language-plaintext highlighter-rouge">keepalived</code> assigned above.<li>${LOAD_BALANCER_PORT} - This is the API Server port assigned above (<code class="language-plaintext highlighter-rouge">6443</code>).</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre>Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$HOME</span>/.kube
<span class="nb">sudo cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
<span class="nb">sudo chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> <span class="nv">$HOME</span>/.kube/config

Alternatively, <span class="k">if </span>you are the root user, you can run:

<span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run <span class="s2">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now <span class="nb">join </span>any number of the control-plane node running the following <span class="nb">command </span>on each as root:

kubeadm <span class="nb">join</span> <span class="k">${</span><span class="nv">LOAD_BALANCER_IP</span><span class="k">}</span>:<span class="k">${</span><span class="nv">LOAD_BALANCER_PORT</span><span class="k">}</span> <span class="nt">--token</span> &lt;token&gt; <span class="se">\</span>
    <span class="nt">--discovery-token-ca-cert-hash</span> &lt;discovery-token&gt; <span class="se">\</span>
    <span class="nt">--control-plane</span> <span class="nt">--certificate-key</span> &lt;certificate key&gt;

Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
As a safeguard, uploaded-certs will be deleted <span class="k">in </span>two hours<span class="p">;</span> If necessary, you can use
  <span class="s2">"kubeadm init phase upload-certs --upload-certs"</span> to reload certs afterward.

Then you can <span class="nb">join </span>any number of worker nodes by running the following on each as root:

kubeadm <span class="nb">join</span> <span class="k">${</span><span class="nv">LOAD_BALANCER_IP</span><span class="k">}</span>:<span class="k">${</span><span class="nv">LOAD_BALANCER_PORT</span><span class="k">}</span> <span class="nt">--token</span> &lt;token&gt; <span class="se">\</span>
    <span class="nt">--discovery-token-ca-cert-hash</span> &lt;discovery-token&gt;
</pre></table></code></div></div><blockquote><p>This is the output fromt he Kubeadm init command. Copy this to a text file for later use.</p></blockquote><blockquote class="prompt-danger"><div><p>Do not Install your CNI to the cluster yet. I’ve tried this multiple times and it seems to not let the other nodes join the cluster. If it works for you, great. For me, I had to wait until the whole cluster is bootstrapped before applying the CNI. (Shown in a later step)</p></div></blockquote><h2 id="9-using-the-first-three-lines-copy-the-clusters-new-kubeconfig-to-the-first-control-planes-home-directory-for-access"><span class="mr-2">9. Using the first three lines copy the clusters new <code class="language-plaintext highlighter-rouge"><span class="mr-2">~/.kube/config</code> to the first control plane’s home directory for access</span><a href="#9-using-the-first-three-lines-copy-the-clusters-new-kubeconfig-to-the-first-control-planes-home-directory-for-access" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$HOME</span>/.kube
<span class="nb">sudo cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
<span class="nb">sudo chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> <span class="nv">$HOME</span>/.kube/config
</pre></table></code></div></div><h2 id="10-join-the-other-two-control-planes-with-the-first-kubeadm-command-provided-from-the-output-you-will-need-to-add-sudo-to-these-commands-it-doesnt-work-without-it"><span class="mr-2">10. Join the other two control planes with the first kubeadm command provided from the output. You will need to add <code class="language-plaintext highlighter-rouge"><span class="mr-2">sudo</code> to these commands, it doesn’t work without it.</span><a href="#10-join-the-other-two-control-planes-with-the-first-kubeadm-command-provided-from-the-output-you-will-need-to-add-sudo-to-these-commands-it-doesnt-work-without-it" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>kubeadm <span class="nb">join</span> <span class="k">${</span><span class="nv">LOAD_BALANCER_IP</span><span class="k">}</span>:<span class="k">${</span><span class="nv">LOAD_BALANCER_PORT</span><span class="k">}</span> <span class="nt">--token</span> &lt;token&gt; <span class="se">\</span>
  <span class="nt">--discovery-token-ca-cert-hash</span> &lt;discovery-token&gt; <span class="se">\</span>
  <span class="nt">--control-plane</span> <span class="nt">--certificate-key</span> &lt;certificate key&gt;
</pre></table></code></div></div><h2 id="11-join-the-worker-nodes-and-storage-nodes-with-the-second-kubeadm-command-provided-by-the-output-you-will-need-to-add-sudo-to-these-commands-it-doesnt-work-without-it"><span class="mr-2">11. Join the worker nodes and storage nodes with the second kubeadm command provided by the output. You will need to add <code class="language-plaintext highlighter-rouge"><span class="mr-2">sudo</code> to these commands, it doesn’t work without it.</span><a href="#11-join-the-worker-nodes-and-storage-nodes-with-the-second-kubeadm-command-provided-by-the-output-you-will-need-to-add-sudo-to-these-commands-it-doesnt-work-without-it" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>kubeadm <span class="nb">join</span> <span class="k">${</span><span class="nv">LOAD_BALANCER_IP</span><span class="k">}</span>:<span class="k">${</span><span class="nv">LOAD_BALANCER_PORT</span><span class="k">}</span> <span class="nt">--token</span> &lt;token&gt; <span class="se">\</span>
  <span class="nt">--discovery-token-ca-cert-hash</span> &lt;discovery-token&gt;
</pre></table></code></div></div><h2 id="12-apply-the-cni-container-network-interface-for-your-cluster"><span class="mr-2">12. Apply the CNI (Container Network Interface) for your cluster.</span><a href="#12-apply-the-cni-container-network-interface-for-your-cluster" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl apply <span class="nt">-f</span> https://docs.projectcalico.org/manifests/calico.yaml
</pre></table></code></div></div><h2 id="13-copy-your-kube-config-to-your-local-machine-from-the-original-control-plane"><span class="mr-2">13. Copy your kube config to your local machine from the original control plane.</span><a href="#13-copy-your-kube-config-to-your-local-machine-from-the-original-control-plane" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo cat</span> ~/.kube/config
</pre></table></code></div></div><blockquote class="prompt-tip"><div><ol><li>You should now have a fully working kubernetes cluster, things to consider are downloading <code class="language-plaintext highlighter-rouge">metallb</code>, <code class="language-plaintext highlighter-rouge">rancher</code>, and <code class="language-plaintext highlighter-rouge">longhorn</code> to make your cluster a little more user friendly. These Guides can be found from <a href="https://techno-tim.github.io/">TechnoTim</a></ol></div></blockquote><h2 id="15-if-you-are-going-to-install-rancher-on-this-cluster-i-noticed-that-the-schedular-and-conroller-manager-said-unhealthy-they-seem-to-work-as-normal-but-a-fix-for-this-is-as-follows"><span class="mr-2">15. If you are going to install Rancher on this cluster, I noticed that the schedular and conroller manager said “unhealthy”. They seem to work as normal, but a fix for this is as follows:</span><a href="#15-if-you-are-going-to-install-rancher-on-this-cluster-i-noticed-that-the-schedular-and-conroller-manager-said-unhealthy-they-seem-to-work-as-normal-but-a-fix-for-this-is-as-follows" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li></ol><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  <span class="nb">sudo </span>nano /etc/kubernetes/manifest/kube-scheduler.yaml
</pre></table></code></div></div><p>and clear the line (spec-&gt;containers-&gt;command) containing this phrase: <code class="language-plaintext highlighter-rouge">- --port=0</code></p><ol><li><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  <span class="nb">sudo </span>nano /etc/kubernetes/manifest/kube-controller.yaml
</pre></table></code></div></div><p>and clear the line (spec-&gt;containers-&gt;command) containing this phrase: <code class="language-plaintext highlighter-rouge">- --port=0</code></p><li><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  <span class="nb">sudo </span>systemctl restart kubelet.service
</pre></table></code></div></div></ol><h3 id="do-this-on-all-three-control-planes-and-it-should-resolve-the-issue"><span class="mr-2">Do this on all <em>THREE</em> Control Planes, and it should resolve the issue.</span><a href="#do-this-on-all-three-control-planes-and-it-should-resolve-the-issue" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/homelab/'>Homelab</a>, <a href='/categories/kubernetes/'>Kubernetes</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/servers/" class="post-tag no-text-decoration" >servers</a> <a href="/tags/ubuntu/" class="post-tag no-text-decoration" >ubuntu</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a> <a href="/tags/high-availability/" class="post-tag no-text-decoration" >high-availability</a> <a href="/tags/ha/" class="post-tag no-text-decoration" >ha</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >docker</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=How to setup a highly-available Kubernetes cluster on Bare-Metal - Guides&amp;url=https://chaseddevelopment.github.io/posts/kubernetes/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=How to setup a highly-available Kubernetes cluster on Bare-Metal - Guides&amp;u=https://chaseddevelopment.github.io/posts/kubernetes/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://chaseddevelopment.github.io/posts/kubernetes/&amp;text=How to setup a highly-available Kubernetes cluster on Bare-Metal - Guides" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/kubernetes/">How to setup a highly-available Kubernetes cluster on Bare-Metal</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/ha/">ha</a> <a class="post-tag" href="/tags/high-availability/">high-availability</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/servers/">servers</a> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/username">Chase Dubauskas</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/ha/">ha</a> <a class="post-tag" href="/tags/high-availability/">high-availability</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/servers/">servers</a> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
